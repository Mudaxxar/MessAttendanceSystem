@using MessManagementSystem.Shared.Models.ResponseModels
@model PaginatedResponseModel<UserResponseModel>
@{
	Layout = "~/Views/Shared/_DreamLayout.cshtml";
}
<style>
	div.dataTables_processing {
		background-color: #35b2c2
	}
	.dropdown-item {
    color: #646B72;
    white-space: unset;
    padding: 0.5rem 0.9375rem;
    font-size: 0.8125rem;
}
</style>
<div class="page-wrapper">
	<div class="content">
		<div class="page-header">
			<div class="page-title">
				<h4>Users List</h4>
				<h6>Manage your Users</h6>
			</div>
			<div class="page-btn">
				<a class="btn btn-added" asp-action="Register" asp-controller="Account"><img src="~/DreamTemplates/images/plus.svg" alt="img">Add User</a>
			</div>
		</div>
		<!-- /role list -->
		<div class="card">
			<div class="card-body">
				<div class="table-responsive">
					<table class="table" id="tblUsers">
						<thead>
							<tr>
								<th style="display:none">Id</th>
								<th>Mess#</th>
								<th>Name</th>
								<th>Email</th>
								<th>Class</th>
								<th>Security Fees</th>
								<th>Balance</th>
								<th>Role</th>
								<th style="display:none"></th>

							</tr>
						</thead>
						<tbody>
							@if (Model is PaginatedResponseModel<UserResponseModel>)
							{
								if (Model.Records is not null)
								{
									foreach (var item in Model.Records)
									{
										<tr>
											<td style=" display:none">@item.Id</td>
											<td>@item.MessNumber</td>
											<td>@item.FirstName</td>
											<td>@item.Email</td>
											<td>@item.BatchClass</td>
											<td>@Convert.ToInt32(item.SecurityFees)</td>
											<td>@Convert.ToInt32(item.Balance)</td>
											<td>@item.Role</td>

											<td class="text-center">
												<a class="action-set" href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="fa fa-ellipsis-v" aria-hidden="true"></i>
												</a>
												<ul class="dropdown-menu" style="">
												
												@* 	<li>
														<a href="javascript:void(0);" class="dropdown-item" data-id="@item.Id" data-bs-toggle="modal" data-bs-target="#showAttendance"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-dollar-sign info-img"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>Show Attendances</a>
													</li> *@
													<li>
														<a href="javascript:void(0);"
														   class="dropdown-item"
														   onclick="setAttendanceUser(5)"
														   data-bs-toggle="modal"
														   data-bs-target="#createAttendance">
															<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
																 viewBox="0 0 24 24" fill="none" stroke="currentColor"
																 stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
																 class="feather feather-plus-circle info-img">
																<circle cx="12" cy="12" r="10"></circle>
																<line x1="12" y1="8" x2="12" y2="16"></line>
																<line x1="8" y1="12" x2="16" y2="12"></line>
															</svg>
															Create Attendance
														</a>
													</li>

																			
												</ul>
											</td>
										</tr>
									}
								}
							}

						</tbody>
					</table>
				</div>
			</div>
		</div>
		<!-- /role list -->
	</div>
</div>

	<!-- Create Attendance Modal -->
		<div class="modal fade" id="createAttendance" aria-hidden="true" style="display: none;">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<div class="page-title">
							<h4>Create Attendances</h4>
						</div>
						<button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
					</div>
						<div class="modal-body">
								<div class="row">
									<div class="col-lg-6">
										<div class="mb-3">
											<label class="form-label"> Date<span class="text-danger ms-1">*</span></label>
											<div class="input-groupicon calender-input">
												<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar info-img"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
												<input id="attendanceDate" type="datetime" class="datetimepicker form-control" placeholder="Choose Date">
											</div>
										</div>
									</div>
									<div class="col-lg-6 col-sm-12 col-12">
										<div class="mb-3">
											<label class="form-label">Attendance Counts<span class="text-danger ms-1">*</span></label>
											<input id="attendanceCount" type="text" class="form-control">
										</div>
									</div>
									<input type="hidden" id="createAttendanceUserId" name="UserId" />
								</div>
								
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
							<button type="submit" class="btn btn-primary" onclick="MarkAttendance()">Submit</button>
						</div>
				</div>
			</div>
		</div>
		<!-- Create Attendance Modal -->
<script>


	$(document).ready(function () {
		var Datatable = null;

		$('#tblUsers').on('draw.dt', function () {
			$('[data-toggle="tooltip"]').tooltip();
		});
		Datatable = $('#tblUsers').DataTable({
			"deferLoading": @Model.TotalRecords,
			"sort": false,
			"processing": true,
			search: {
				return: true
			},
			"serverSide": true,
			"ajax": {
				"url": "@Url.Action("GetUsers")",
				"type": "POST",
				"datatype": "json"
			},

			columns: [
				{ data: 'id', name: 'Id', autowidth: true,visible:false },
				{ data: 'messNumber', name: 'MessNumber', autowidth: true },
				{ data: 'firstName', name: 'FirstName', autoWidth: true },
				{ data: 'email', name: 'Email', autoWidth: true },
				{ data: 'batchClass', name: 'BatchClass', autoWidth: true },
				{ data: 'securityFees', name: 'SecurityFees', autoWidth: true },
				{ data: 'balance', name: 'Balance', autoWidth: true },
				{ data: 'role', name: 'Role', autoWidth: true },
				
				{
					data: "action", name: "Action", autoWidth: true,
					render: function (data, type, row, meta) {
						debugger;
						return `<a class="action-set" href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false">
														<i class="fa fa-ellipsis-v" aria-hidden="true"></i>
													</a>
													<ul class="dropdown-menu" style="">

														<li>
															<a href="javascript:void(0);"
															class="dropdown-item"
																data-id="(${row.id})"
																	onclick="setAttendanceUser(${row.id})"
															data-bs-toggle="modal"
															data-bs-target="#createAttendance">
															<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-circle info-img"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>Create Attendance</a>
														</li>

													</ul>`;
					}
				},
				
			]


		});
		$('[data-toggle="tooltip"]').tooltip();

		$('#tblUsers_filter input').unbind();
		$('#tblUsers_filter input').bind('keyup', function (e) {
			if (e.keyCode == 13) {
				Datatable.search(this.value).draw();
			}
		});
	});

  function MarkAttendance() {
	  debugger;
    var userId = $('#createAttendanceUserId').val()?.trim();
    var count = $('#attendanceCount').val()?.trim();

		var dateInput = $('#attendanceDate').val()?.trim(); // "15-07-2025"
		var momentDate = moment(dateInput, 'DD-MM-YYYY');   // ✅ match actual input
		var isoDate = momentDate.format('YYYY-MM-DD');      // "2025-07-15"

    // Basic validation (same as before)
    if (!userId && userId === 'undefined') {
        toastr.error("User ID is missing.");
        return;
    }
		if (!isoDate) {
        toastr.error("Date is required.");
        return;
    }
    if (!count || isNaN(count) || parseInt(count) <= 0) {
        toastr.error("Attendance count must be a positive number.");
        return;
    }
    
 
    $.ajax({
        url: '/Attendance/MarkAttendance',
        type: 'POST',
        contentType: 'application/json',
			data: JSON.stringify({ userId: userId, AttendanceCount: count, status: 1, date: isoDate }),
        success: function (result) {
            toastr.success(result.message || "Attendance marked successfully!");
				$('#createAttendance').modal('hide');

        },
        error: function () {
            toastr.error("Something went wrong while submitting attendance.");
        }
    });
}

	function setAttendanceUser(id) {
		debugger;
		document.getElementById('createAttendanceUserId').value = id;
	}

</script>
