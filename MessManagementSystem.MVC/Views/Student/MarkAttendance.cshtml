@using MessManagementSystem.Shared.Models.ResponseModels
@using static MessManagementSystem.Shared.Enums.Enums
@model PaginatedResponseModel<AttendanceResponseModel>
@{
    ViewData["Title"] = "Mark Attendance";
    Layout = "~/Views/Shared/_DreamLayout.cshtml";
}

<!-- Page Wrapper -->
<div class="page-wrapper">
    <div class="content">

        <!-- Header -->
        <div class="text-center mb-5">
            <h2 class="fw-bold text-success">🍽️ Meal Attendance</h2>
            <p class="text-muted">Select your attendance status for today's meal</p>
        </div>

        <!-- Attendance Form -->
        <div class="d-flex justify-content-center">
            <div class="card shadow-lg border-0 rounded-4 p-4" style="max-width: 500px; width: 100%;">
                <div class="card-body">
                    <form id="attendanceForm">
                        <div class="mb-4 text-center">
                            <h5 class="fw-semibold text-dark mb-3">Choose your attendance status</h5>

                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="status" id="present" value="present" autocomplete="off" checked>
                                <label class="btn btn-outline-success fw-semibold px-4 py-2 rounded-start" for="present">✅ Accept Meal</label>

                                <input type="radio" class="btn-check" name="status" id="absent" value="absent" autocomplete="off">
                                <label class="btn btn-outline-danger fw-semibold px-4 py-2 rounded-end" for="absent">❌ Decline Meal</label>
                            </div>

                            <div class="mt-3">
                                <span class="badge bg-light text-dark shadow-sm px-3 py-2">
                                    You selected: <strong id="selectedStatus">Present</strong>
                                </span>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-success rounded-pill fw-bold py-2 shadow-sm" onclick="SaveAttendance()">
                                ✅ Submit Attendance
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Attendance History -->
        <div class="mt-5">
            <div class="card shadow-sm">
                <div class="card-header bg-white border-0">
                    <h4 class="mb-0">📅 Attendance History</h4>
                    <small class="text-muted">View your meal attendance record</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tblAttendance">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model?.Records is not null)
                                {
                                    foreach (var item in Model.Records)
                                    {
                                        <tr>
                                            <td>@Convert.ToDateTime(item.Date).ToString("dddd, MMM dd, yyyy")</td>
                                            <td>
                                                <span class="badge @((item.Status == PresenceStatus.Present) ? "bg-success" : "bg-danger") text-white">
                                                    @item.Status
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
@section Scripts {
    <script>
        const statusMap = {
            present: 1,
            absent: 2
        };
        function updateSelectedStatus() {
            const selected = $('input[name="status"]:checked').val();
            $('#selectedStatus').text(selected.charAt(0).toUpperCase() + selected.slice(1));
        }

        $('input[name="status"]').on("change", updateSelectedStatus);

        function SaveAttendance() {
            debugger;
            var selected = $('input[name="status"]:checked').val();
            var enumValue = statusMap[selected];

            if (!enumValue) {
                toastr.error("Please select attendance status.");
                return;
            }

            $.ajax({
                url: '/student/MarkAttendance',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ status: enumValue }),
                success: function (result) {
                    if (result && result.message) {
                        toastr.success(result.message);
                    } else {
                        toastr.success("Attendance marked successfully!");
                    }
                },
                error: function (xhr) {
                    toastr.error("Something went wrong while submitting attendance.");
                }
            });
        }

        // Initial selection text update
        updateSelectedStatus();



        //History table
        $(document).ready(function () {
            var Datatable = null;

            $('#tblAttendance').on('draw.dt', function () {
                $('[data-toggle="tooltip"]').tooltip();
            });
            Datatable = $('#tblAttendance').DataTable({
                "deferLoading": @Model.TotalRecords,
                "sort": false,
                "processing": true,
                search: {
                    return: true
                },
                "serverSide": true,
                "ajax": {
                    "url": "@Url.Action("GetAttendance")",
                    "type": "POST",
                    "datatype": "json"
                },

                columns: [

                    {
                        data: 'date',
                        name: 'Date',
                        autoWidth: true,
                        render: function (data, type, row) {
                            return moment(data).format("dddd, MMMM, yyyy");
                        }
                    },
                    {
                        data: 'status',
                        name: 'Status',
                        autoWidth: true,
                        render: function (data, type, row) {
                            // Check if data contains any HTML tags
                            const hasHtml = /<\/?[a-z][\s\S]*>/i.test(data);

                            if (hasHtml) {
                                return data; // Already contains HTML span badge
                            }

                            const isPresent = data === 1 || data === "1";
                            const badgeClass = isPresent ? "bg-success" : "bg-danger";
                            const label = isPresent ? "Present" : "Absent";
                            return `<span class="badge ${badgeClass} text-white">${label}</span>`;
                        }
                    }


                   
                ]


            });
            $('[data-toggle="tooltip"]').tooltip();

            $('#tblAttendance_filter input').unbind();
            $('#tblAttendance_filter input').bind('keyup', function (e) {
                if (e.keyCode == 13) {
                    Datatable.search(this.value).draw();
                }
            });
        });
    </script>
}
